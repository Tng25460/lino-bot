from __future__ import annotations

import time
from typing import Any, Dict, List

from config import settings


class TradingEngine:
    def __init__(self, wallet, logger, positions_file: str, mode: str):
        self.wallet = wallet
        self.logger = logger
        self.positions_file = positions_file
        self.mode = mode

        self.last_buy_ts = 0.0

        from core.real_executor import RealExecutor
        from core.paper_executor import PaperExecutor

        if mode == "REAL":
            self.executor = RealExecutor(wallet, logger)
        else:
            self.executor = PaperExecutor(wallet, logger)

        self.logger.info(
            f"[TradingEngine] Initialisé (mode={mode}, SL + trailing activé)."
        )

    async def on_overviews(self, overviews: List[Dict[str, Any]], risk_checker):
        self.logger.info('[DBG_ENTER] on_overviews called, n=%s' % (len(overviews) if overviews else 0))
        did_buy = False
        now = time.time()

        for ov in overviews:
            if did_buy:
                break

            mint = ov.get("address")
            price = ov.get("price")

            if not mint or not price:
                continue

            # cooldown global
            if now - self.last_buy_ts < settings.BUY_COOLDOWN_SECONDS:
                continue

            self.logger.info(f"[DBG_PRE_RISK] mint={ov.get('mint') or ov.get('token')} liq={ov.get('liquidity_usd')} mc={ov.get('marketcap_usd')} price={ov.get('price_usd')} data={ov.get('data')}")
            ok, reason = risk_checker.allow_buy(ov)
            self.logger.info(f"[DBG_RISK] mint={ov.get('mint') or ov.get('token')} ok={ok} reason={reason} liq={((ov.get('data') or {}).get('liquidity'))} mc={((ov.get('data') or {}).get('marketCap'))} price={ov.get('price_usd')}")
            self.logger.info(f"[RISK] ok={ok} reason={reason} mint={ov.get("mint")}")
            if not ok:
                self.logger.info(f"[BUY] Skip {mint} (risk: {reason})")
                continue

            self.logger.info(
                f"[BUY] Signal {mint} price~{price:.8f} size={settings.BUY_AMOUNT_SOL} SOL mode={self.mode}"
            )

            try:
                if self.mode == "REAL":
                    self.logger.info(f"[REAL BUY] {mint}")
                    await self.logger.info(f"[DBG_BEFORE_BUY] trying BUY mint={mint} price={price} sol_amount={sol_amount}")
            self.executor.buy(mint, settings.BUY_AMOUNT_SOL)
                else:
                    self.logger.info(f"[PAPER BUY] {mint}")
                    await self.executor.buy(mint, settings.BUY_AMOUNT_SOL)

                self.last_buy_ts = now
                did_buy = True

            except Exception as e:
                self.logger.error(f"[BUY ERROR] {mint}: {e}")

        self._print_portfolio()

    def _print_portfolio(self):
        self.logger.info(
            "[PORTFOLIO] mode=%s cash=%.4f equity=%.4f open=%d closed=%d pnl=+%.4f",
            self.mode,
            1.0,
            1.0,
            0,
            0,
            0.0,
        )
