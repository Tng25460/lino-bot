from __future__ import annotations

import httpx
from typing import Any, Dict, Optional


class JupiterAsyncClient:
    """
    Jupiter officiel:
      Base:   https://api.jup.ag
      Header: x-api-key: <key>
      Price:  GET /price/v2?ids=<mint>
    """

    def __init__(self, api_key: str, base_url: str = "https://api.jup.ag", timeout: float = 15.0):
        api_key = (api_key or "").strip()
        if not api_key:
            raise ValueError("JUPITER_API_KEY manquant (vide).")

        self.base_url = (base_url or "https://api.jup.ag").rstrip("/")
        self._headers = {
            "x-api-key": api_key,
            "accept": "application/json",
        }
        self._client = httpx.AsyncClient(
            base_url=self.base_url,
            timeout=timeout,
            headers=self._headers,
        )

    async def aclose(self) -> None:
        await self._client.aclose()

    async def price_v2(self, ids: str) -> Dict[str, Any]:
        r = await self._client.get("/price/v2", params={"ids": ids})
        if r.status_code == 401:
            raise RuntimeError(f"JUPITER_HTTP_401: {r.text}")
        r.raise_for_status()
        return r.json()

    async def price_one(self, mint: str) -> Optional[float]:
        j = await self.price_v2(mint)
        data = (j or {}).get("data") or {}
        node = data.get(mint) or {}
        price = node.get("price")
        if price is None:
            return None
        try:
            return float(price)
        except Exception:
            return None
PY && \
python3 -m py_compile core/jupiter_async.py && \
echo "✅ OK: jupiter_async.py patché (header x-api-key forcé)"

