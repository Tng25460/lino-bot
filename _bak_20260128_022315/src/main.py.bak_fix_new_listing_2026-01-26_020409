from __future__ import annotations

import asyncio
import os
import sys
from typing import Any, Dict, List

# Assure les imports "core.*" et "config.*"
PROJECT_ROOT = os.path.abspath(os.path.join(os.path.dirname(__file__), ".."))
from dotenv import load_dotenv
# Auto-load env (API keys, base URLs)
try:
    load_dotenv(os.path.join(PROJECT_ROOT, '.env.real'), override=True)
except Exception:
    pass

if PROJECT_ROOT not in sys.path:
    sys.path.insert(0, PROJECT_ROOT)

from config import settings
from core.logger import get_logger
from core.wallet import Wallet
from core.risk_checks import RiskChecker
from core.trading import TradingEngine
from core.token_scanner import TokenScanner, ScannerConfig


ASCII_LINO = r"""
â–ˆâ–ˆâ•—     â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—
â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
â•šâ•â•â•â•â•â•â•â•šâ•â•â•šâ•â•  â•šâ•â•â•â• â•šâ•â•â•â•â•â•
L I N O   B O T
"""


def _get_float(name: str, default: float) -> float:
    v = os.getenv(name)
    if not v:
        return default
    try:
        return float(v)
    except Exception:
        return default


async def run_loop() -> None:
    logger = get_logger()

    logger.info(f"Bot Lino dÃ©marrÃ© en mode {settings.MODE}")
    logger.info(ASCII_LINO)

    wallet = Wallet()
    logger.info(f"[WALLET] Loaded keypair with pubkey: {wallet.pubkey()}")

    risks = RiskChecker()

    engine = TradingEngine(
        wallet=wallet,
        logger=logger,
        positions_file=os.path.join(PROJECT_ROOT, "positions.json"),
        mode=settings.MODE,
    )

    # -------- Scanner --------
    # -------- Jupiter API KEY (ne doit plus bloquer le bot) --------
    # On accepte plusieurs noms pour Ã©viter "on me redemande la clÃ©"
    jup_key = (
        os.getenv("JUPITER_API_KEY")
        or os.getenv("JUP_API_KEY")
        or os.getenv("JUPITER_KEY")
        or getattr(settings, "JUPITER_API_KEY", "")
        or getattr(settings, "JUP_API_KEY", "")
    )
    if not jup_key:
        logger.warning("[WARN] Aucune clÃ© Jupiter trouvÃ©e. Le bot continue (scanner DexScreener OK), mais swaps/quotes Jupiter peuvent Ã©chouer.")

    cfg = ScannerConfig(
        new_listing_limit=int(getattr(settings, "NEW_LISTING_LIMIT", 5)),
        global_rps=float(getattr(settings, "GLOBAL_RPS", 0.2)),
        max_concurrency=int(getattr(settings, "MAX_CONCURRENCY", 1)),
        min_liquidity_usd=_get_float("MIN_LIQUIDITY_USD", 1000.0),
        max_market_cap_usd=_get_float("MAX_MARKET_CAP_USD", 300000.0),
    )

    scanner = TokenScanner(cfg)
    logger.info(
        f"[Scanner] âœ… limit={cfg.new_listing_limit} rps={cfg.global_rps} conc={cfg.max_concurrency}"
    )

    try:
        while True:
            try:
                overviews: List[Dict[str, Any]] = await scanner.scan_once_async()
                logger.info(f"[DBG_OV] {overviews[:2]}")
                logger.info(f"[Main] overviews reÃ§us: {len(overviews)}")
            except Exception as e:
                logger.error(f"[TokenScanner] scan error: {e}", exc_info=True)
                overviews = []

            # ðŸ”¥ TOUJOURS appeler lâ€™engine, mÃªme si overviews est vide
            logger.info(
                f"[DBG_MAIN_BEFORE_ENGINE] calling engine.on_overviews n={len(overviews)}"
            )
            await engine.on_overviews(overviews, risks)

            await asyncio.sleep(getattr(settings, "SCAN_INTERVAL_SECONDS", 25))

    except KeyboardInterrupt:
        logger.info("ArrÃªt demandÃ© (CTRL+C).")
    finally:
        try:
            await scanner.aclose()
        except Exception:
            pass
        logger.info("Bot Lino arrÃªtÃ©.")


def main() -> None:
    logger = get_logger()
    try:
        asyncio.run(run_loop())
    except Exception as e:
        logger.error(f"[MAIN ERROR] {e}", exc_info=True)
        logger.info("Bot Lino arrÃªtÃ©.")


if __name__ == "__main__":
    main()
