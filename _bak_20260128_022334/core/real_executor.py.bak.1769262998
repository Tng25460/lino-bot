from __future__ import annotations

from typing import Any, Dict, Optional

from config import settings


class RealExecutor:
    def __init__(self, wallet, logger):
        self.wallet = wallet
        self.logger = logger

        rpc_url = getattr(settings, "RPC_URL", "https://api.mainnet-beta.solana.com")
        self.logger.info("[RealExecutor] initialisé (rpc=%s)", rpc_url)

        from core.raydium_client import RaydiumClient
        self.raydium = RaydiumClient(wallet=self.wallet, logger=self.logger, rpc_url=rpc_url)

    async def buy(self, mint: str, sol_amount: float, price: float) -> Dict[str, Any]:
        slippage_bps = int(getattr(settings, "SLIPPAGE_BPS", 300) or 300)
        self.logger.info("[REAL BUY] token_address=%s sol=%s price=%s slippage_bps=%s", mint, sol_amount, price, slippage_bps)

        tx_sig = await self.raydium.swap_sol_to_token(
            token_mint=mint,
            sol_in=sol_amount,
            slippage_bps=slippage_bps,
        )
        return {"tx": tx_sig}

    async def sell(self, mint: str) -> Dict[str, Any]:
        """
        Vend TOUT le token (mint) -> SOL.
        IMPORTANT: il faut que RaydiumClient ait une méthode swap_token_to_sol().
        Si ton RaydiumClient ne l'a pas encore, dis-moi et je te donne le patch complet.
        """
        slippage_bps = int(getattr(settings, "SLIPPAGE_BPS", 300) or 300)
        self.logger.info("[REAL SELL] mint=%s slippage_bps=%s", mint, slippage_bps)

        if not hasattr(self.raydium, "swap_token_to_sol"):
            raise RuntimeError("RaydiumClient n'a pas swap_token_to_sol(). Ajoute-la pour activer la vente REAL.")

        tx_sig = await self.raydium.swap_token_to_sol(
            token_mint=mint,
            slippage_bps=slippage_bps,
        )
        return {"tx": tx_sig}
