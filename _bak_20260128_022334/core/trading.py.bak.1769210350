from __future__ import annotations

import time
from typing import Any, Dict, List

from config import settings


class TradingEngine:
    def __init__(self, wallet, logger, positions_file: str, mode: str):
        self.wallet = wallet
        self.logger = logger
        self.positions_file = positions_file
        self.mode = mode
        self.last_buy_ts = 0.0

        from core.real_executor import RealExecutor
        from core.paper_executor import PaperExecutor

        if mode == "REAL":
            self.executor = RealExecutor(wallet, logger)
        else:
            self.executor = PaperExecutor(wallet, logger)

        self.logger.info(
            f"[TradingEngine] Initialisé (mode={mode}, SL + trailing activé)."
        )

    async def on_overviews(self, overviews: List[Dict[str, Any]], risk_checker):
        self.logger.info(
            "[DBG_ENTER] on_overviews called, n=%s",
            len(overviews) if overviews else 0,
        )

        did_buy = False
        now = time.time()

        for ov in overviews:
            if did_buy:
                break

            mint = ov.get("mint") or ov.get("token") or ov.get("address")
            price = ov.get("price_usd") or ov.get("price")

            if not mint or not price:
                continue

            # Cooldown global
            if now - self.last_buy_ts < settings.BUY_COOLDOWN_SECONDS:
                continue

            self.logger.info(
                "[DBG_PRE_RISK] mint=%s liq=%s mc=%s price=%s",
                mint,
                ov.get("liquidity_usd"),
                ov.get("marketcap_usd"),
                price,
            )

            ok, reason = risk_checker.allow_buy(ov)

            self.logger.info(
                "[DBG_RISK] mint=%s ok=%s reason=%s",
                mint,
                ok,
                reason,
            )

            if not ok:
                self.logger.info("[BUY] Skip %s (risk: %s)", mint, reason)
                continue

            self.logger.info(
                "[BUY] Signal %s price~%.8f size=%.4f SOL mode=%s",
                mint,
                float(price),
                float(settings.BUY_AMOUNT_SOL),
                self.mode,
            )

            try:
                self.logger.info(
                    "[DBG_BEFORE_BUY] mint=%s price=%s sol_amount=%s mode=%s",
                    mint,
                    price,
                    settings.BUY_AMOUNT_SOL,
                    self.mode,
                )

                res = self.executor.buy(
                    mint,
                    float(price),
                    float(settings.BUY_AMOUNT_SOL),
                )

                if hasattr(res, "__await__"):
                    await res

                self.last_buy_ts = now
                did_buy = True

                self.logger.info("[BUY OK] %s", mint)

            except Exception as e:
                self.logger.error("[BUY ERROR] %s: %s", mint, e)

        self._print_portfolio()

    def _print_portfolio(self):
        self.logger.info(
            "[PORTFOLIO] mode=%s cash=%.4f equity=%.4f open=%d closed=%d pnl=+%.4f",
            self.mode,
            1.0,
            1.0,
            0,
            0,
            0.0,
        )
