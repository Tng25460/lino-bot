#!/usr/bin/env python3
import os
import json
import sys
from pathlib import Path

# -----------------------
# Helpers
# -----------------------

def load_ready(path: str):
    rows = []
    with open(path, "r", encoding="utf-8", errors="ignore") as f:
        for line in f:
            line = line.strip()
            if not line:
                continue
            try:
                rows.append(json.loads(line))
            except Exception:
                continue
    return rows

def score_used(o):
    if o.get("score_v4") is not None:
        return o.get("score_v4")
    if o.get("score2") is not None:
        return o.get("score2")
    return o.get("score")

def pick_best(rows):
    rows = [r for r in rows if score_used(r) is not None]
    if not rows:
        return None
    rows.sort(key=lambda r: float(score_used(r)), reverse=True)
    return rows[0]

# -----------------------
# MAIN
# -----------------------

def main():
    ready_file = os.getenv("READY_FILE", "ready_to_trade.jsonl")
    dry_run = os.getenv("TRADER_DRY_RUN", "0") in ("1", "true", "True")

    if not Path(ready_file).exists():
        print(f"‚ùå READY_FILE not found: {ready_file}", flush=True)
        return 1

    rows = load_ready(ready_file)
    print("üöÄ trader_exec BUY", flush=True)
    print("   ready_file=", ready_file, flush=True)
    print("   dry_run=", dry_run, flush=True)
    print("   ready_count=", len(rows), flush=True)

    if not rows:
        print("‚ö†Ô∏è empty READY_FILE", flush=True)
        return 0

    best = pick_best(rows)
    if not best:
        print("‚ö†Ô∏è no candidate with score", flush=True)
        return 0

    su = score_used(best)

    print(
        f"[DECISION] PICK "

    # Route policy (preferred DEX order)
    dexes = best.get("dexes") or []
    allowed_dexes = []
    for d in ["meteora","raydium","orca"]:
        if d in dexes:
            allowed_dexes.append(d)
    if not allowed_dexes:
        allowed_dexes = ["raydium","meteora","orca"]

    print(f"üîÄ route_policy allowed_dexes={allowed_dexes}", flush=True)
        f"mint={best.get('mint')} "
        f"score_used={su} "
        f"score_v4={best.get('score_v4')} "
        f"origin={best.get('origin')} "
        f"dexes={best.get('dexes')} "
        f"liq={best.get('liquidity_usd')} "
        f"vol24={best.get('vol_24h')} "
        f"tx1h={best.get('txns_1h')} "
        f"chg1h={best.get('chg_1h')}",
        flush=True
    )

    if dry_run:
        print("üß™ TRADER_DRY_RUN=1 -> not sending tx", flush=True)
        return 0

    # REAL BUY would go here
    print("‚ùå REAL BUY not wired yet", flush=True)
    return 0

if __name__ == "__main__":
    raise SystemExit(main())
