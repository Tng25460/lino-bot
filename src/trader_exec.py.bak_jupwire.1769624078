#!/usr/bin/env python3
import os
import json
import sys

# -----------------------
# Config
# -----------------------

READY_FILE = os.getenv("READY_FILE", "ready_to_trade_ranked_v4_orca.jsonl")
DRY_RUN = os.getenv("TRADER_DRY_RUN", "0") in ("1","true","True")

# -----------------------
# Helpers
# -----------------------

def load_ready(path):
    rows = []
    try:
        with open(path, "r", encoding="utf-8", errors="ignore") as f:
            for line in f:
                line = line.strip()
                if not line:
                    continue
                rows.append(json.loads(line))
    except FileNotFoundError:
        print(f"‚ùå READY_FILE not found: {path}", flush=True)
    return rows

def score_used(o):
    if o.get("score_v4") is not None:
        return float(o["score_v4"])
    if o.get("score2") is not None:
        return float(o["score2"])
    return float(o.get("score", 0.0))

# -----------------------
# Main
# -----------------------

def main():
    print("üöÄ trader_exec BUY", flush=True)
    print(f"   ready_file= {READY_FILE}", flush=True)
    print(f"   dry_run= {DRY_RUN}", flush=True)

    rows = load_ready(READY_FILE)
    print(f"   ready_count= {len(rows)}", flush=True)

    if not rows:
        print("‚ö†Ô∏è no candidates", flush=True)
        return 0

    # pick best by score
    best = max(rows, key=score_used)

    mint = best.get("mint")
    score = score_used(best)
    origin = best.get("origin")
    dexes = best.get("dexes", [])
    liq = best.get("liquidity_usd") or best.get("liq_usd")
    vol24 = best.get("vol_24h")
    tx1h = best.get("txns_1h")
    chg1h = best.get("chg_1h")

    print(
        f"[DECISION] PICK "
        f"mint={mint} "
        f"score_used={score:.4f} "
        f"origin={origin} "
        f"dexes={dexes} "
        f"liq={liq} "
        f"vol24={vol24} "
        f"tx1h={tx1h} "
        f"chg1h={chg1h}",
        flush=True
    )

    # -----------------------
    # Route policy
    # -----------------------
    allowed_dexes = []
    for d in ("meteora", "raydium", "orca"):
        if d in dexes:
            allowed_dexes.append(d)

    if not allowed_dexes:
        allowed_dexes = ["raydium", "meteora", "orca"]

    print(f"üîÄ route_policy allowed_dexes={allowed_dexes}", flush=True)

    # -----------------------
    # Execution (dry-run only for now)
    # -----------------------
    if DRY_RUN:
        print("üß™ TRADER_DRY_RUN=1 -> not sending tx", flush=True)
        return 0

    print("‚ùå LIVE BUY not wired yet", flush=True)
    return 0


if __name__ == "__main__":
    sys.exit(main())
