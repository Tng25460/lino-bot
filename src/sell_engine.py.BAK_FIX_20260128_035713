from __future__ import annotations

import os
import time
import asyncio
from pathlib import Path

# This file is intentionally conservative: it must NEVER crash run_live.
# We'll plug full TP/SL/trailing logic after stability is restored.

DEFAULT_DB = os.getenv("DB_PATH", "state/trades.sqlite")


def _wallet_pubkey() -> str:
    return (os.getenv("WALLET_PUBKEY") or os.getenv("TRADER_USER_PUBLIC_KEY") or "").strip()


async def _tick(db_path: str, wallet: str) -> None:
    # Minimal check so the loop is alive; no DB writes.
    # Later we’ll implement full sell logic here.
    _ = db_path
    _ = wallet
    await asyncio.sleep(0)


def sell_engine(db_path: str | None = None, *args, **kwargs):
    db_path = db_path or DEFAULT_DB
    wallet = _wallet_pubkey()

    print("✅ sell_engine: clean wrapper started")
    print("   db_path=", db_path)
    if not wallet:
        print("⚠️ sell_engine: missing WALLET_PUBKEY/TRADER_USER_PUBLIC_KEY -> running idle loop")

    # Small step loop
    while True:
        try:
            asyncio.run(_tick(db_path, wallet))
        except Exception as e:
            print("❌ sell_engine tick error:", e)
        time.sleep(float(os.getenv("SELL_ENGINE_SLEEP_S", "2.0")))


# Keep compatibility if someone imports SellEngine symbol
class SellEngine:
    def __init__(self, db_path: str = DEFAULT_DB, wallet: str | None = None):
        self.db_path = db_path
        self.wallet = wallet or _wallet_pubkey()

    async def run_once(self, wallet: str | None = None):
        await _tick(self.db_path, wallet or self.wallet)


if __name__ == "__main__":
    sell_engine()
