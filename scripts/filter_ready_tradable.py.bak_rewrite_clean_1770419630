#!/usr/bin/env python3
import os, json, time
from pathlib import Path

import requests

# === CONFIG ===
INP = os.getenv("READY_TRADABLE_IN", "state/ready_pump_early.jsonl")
OUT = os.getenv("READY_TRADABLE_OUT", "state/ready_tradable.jsonl")

INPUT_MINT = os.getenv("INPUT_MINT", "So11111111111111111111111111111111111111112")
JUP = (os.getenv("JUP_BASE_URL", "https://lite-api.jup.ag") or "").rstrip("/")

AMOUNT_LAMPORTS = int(float(os.getenv("BUY_AMOUNT_SOL", "0.003")) * 1_000_000_000)
SLIPPAGE_BPS = int(os.getenv("SLIPPAGE_BPS", "120"))

RETRIES = int(os.getenv("FILTER_QUOTE_RETRIES", "6"))
TIMEOUT_S = float(os.getenv("FILTER_TIMEOUT_S", "10.0"))

SLEEP_S = float(os.getenv("FILTER_SLEEP_S", "0.20"))
SLEEP_429_S = float(os.getenv("FILTER_429_SLEEP_S", "2.0"))

# If 429, keep item (soft pass) or drop it (soft skip)
ON_429_KEEP = os.getenv("FILTER_ON_429_KEEP", "1") == "1"

MAX_N = int(os.getenv("FILTER_MAX_N", "0"))  # 0 = no limit

def _jup_headers(jup_base: str):
    # api.jup.ag requires x-api-key (pro). lite-api generally doesn't.
    if "api.jup.ag" in (jup_base or ""):
        key = (os.getenv("JUP_API_KEY", "") or "").strip()
        if key:
            return {"x-api-key": key}
    return {}

def _read_jsonl(path: str):
    p = Path(path)
    if not p.exists():
        return []
    out = []
    for line in p.read_text(encoding="utf-8", errors="ignore").splitlines():
        line = line.strip()
        if not line:
            continue
        try:
            out.append(json.loads(line))
        except Exception:
            continue
    return out

def _quote(sess: requests.Session, output_mint: str):
    url = f"{JUP}/swap/v1/quote"
    params = {
        "inputMint": INPUT_MINT,
        "outputMint": output_mint,
        "amount": str(int(AMOUNT_LAMPORTS)),
        "slippageBps": str(int(SLIPPAGE_BPS)),
    }

    last = None
    for i in range(RETRIES + 1):
        try:
            if SLEEP_S > 0:
                time.sleep(SLEEP_S)

            r = sess.get(
                url,
                params=params,
                timeout=TIMEOUT_S,
                headers=_jup_headers(JUP),
            )

            sc = r.status_code
            txt = (r.text or "")[:240]
            last = (sc, txt)

            if sc == 200:
                return True, sc, txt

            if sc == 401:
                # hard fail on auth problems (wrong/missing key)
                return False, sc, txt

            if sc == 429:
                if SLEEP_429_S > 0:
                    time.sleep(SLEEP_429_S)
                continue

            # other HTTP => retry a bit
            time.sleep(min(0.4 + 0.2 * i, 2.0))
            continue

        except Exception as e:
            last = ("EXC", repr(e))
            time.sleep(min(0.4 + 0.2 * i, 2.0))
            continue

    # exhausted retries
    return False, (last[0] if last else "NO"), (last[1] if last else "")

def main():
    items = _read_jsonl(INP)
    if MAX_N > 0:
        items = items[:MAX_N]

    print(f"[filter_ready_tradable] INP={INP} OUT={OUT}", flush=True)
    print(f"[filter_ready_tradable] JUP={JUP} amount={AMOUNT_LAMPORTS} slip_bps={SLIPPAGE_BPS} retries={RETRIES} on429_keep={1 if ON_429_KEEP else 0}", flush=True)

    kept, bad, soft429, unauth = 0, 0, 0, 0
    out_lines = []

    with requests.Session() as sess:
        for idx, it in enumerate(items, 1):
            mint = (it.get("mint") or it.get("outputMint") or "").strip()
            if not mint:
                bad += 1
                continue

            ok, code, txt = _quote(sess, mint)

            if ok:
                out_lines.append(json.dumps(it, ensure_ascii=False))
                kept += 1
            else:
                if code == 429 or str(code) == "429":
                    soft429 += 1
                    if ON_429_KEEP:
                        out_lines.append(json.dumps(it, ensure_ascii=False))
                        kept += 1
                elif code == 401 or str(code) == "401":
                    unauth += 1
                    bad += 1
                    # print one sample then stop early (no point continuing)
                    print(f"[filter_ready_tradable] ‚ùå http=401 Unauthorized (check JUP_API_KEY). sample={txt}", flush=True)
                    break
                else:
                    bad += 1

            if idx % 10 == 0:
                print(f"[{idx}/{len(items)}] kept={kept} bad={bad} soft429={soft429} unauth={unauth}", flush=True)

    Path(OUT).parent.mkdir(parents=True, exist_ok=True)
    Path(OUT).write_text("\n".join(out_lines) + ("\n" if out_lines else ""), encoding="utf-8")

    print(f"DONE kept={kept} bad={bad} soft429={soft429} unauth={unauth} OUT={OUT}", flush=True)

if __name__ == "__main__":
    main()
