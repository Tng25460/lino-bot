from __future__ import annotations

import os
from typing import Any, Optional

from config import settings
from core.solana_client import SolanaClient
from core.raydium_client import RaydiumClient


class RealExecutor:
    def __init__(self, wallet: Any, logger: Any):
        self.wallet = wallet
        self.logger = logger

        self.rpc_url = os.getenv("RPC_URL") or getattr(
            settings, "RPC_URL", "https://api.mainnet-beta.solana.com"
        )

        # Ton SolanaClient.__init__ = (self) => pas d'args
        self.solana_client = SolanaClient()

        # On passe bien wallet + logger au RaydiumClient
        self.raydium = RaydiumClient(
            rpc_url=self.rpc_url,
            solana_client=self.solana_client,
            wallet=self.wallet,
            logger=self.logger,
        )

        self.logger.info("[RealExecutor] initialisé (rpc=%s)", self.rpc_url)

    async def buy(
        self,
        token_address: str,
        sol_amount: float,
        price: Optional[float] = None,
        slippage_bps: Optional[int] = None,
    ) -> str:
        if not self.wallet:
            raise RuntimeError("Wallet manquant (swap REAL impossible).")

        slippage_bps = (
            int(slippage_bps)
            if slippage_bps is not None
            else int(getattr(settings, "SLIPPAGE_BPS", 300))
        )

        self.logger.info(
            "[REAL BUY] token_address=%s sol=%s price=%s slippage_bps=%s",
            token_address,
            sol_amount,
            price,
            slippage_bps,
        )

        tx = await self.raydium.swap_sol_to_token(
            token_address=token_address,
            sol_amount=float(sol_amount),
            slippage_bps=slippage_bps,
        )

        if isinstance(tx, str) and len(tx) > 10:
            self.logger.info("[BUY OK] %s tx=%s", token_address, tx)
            return tx

        raise RuntimeError(f"Raydium: aucune tx reçue: {tx!r}")
