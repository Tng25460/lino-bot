import os
import time

class SellEngine:
    def __init__(self, db, price_feed, trader):
        self.db = db
        self.price_feed = price_feed
        self.trader = trader

        # === STRATEGY PARAMS (ENV) ===
        self.HARD_SL = float(os.getenv("SELL_HARD_SL_PCT", "0.25"))        # -25%
        self.TP1_PCT = float(os.getenv("SELL_TP1_PCT", "0.30"))            # +30%
        self.TP1_SIZE = float(os.getenv("SELL_TP1_SIZE", "0.35"))          # sell 35%
        self.TP2_PCT = float(os.getenv("SELL_TP2_PCT", "0.80"))            # +80%
        self.TP2_SIZE = float(os.getenv("SELL_TP2_SIZE", "0.35"))          # sell 35%
        self.TRAIL_TIGHT = float(os.getenv("SELL_TRAIL_TIGHT", "0.10"))    # 10%
        self.TRAIL_WIDE = float(os.getenv("SELL_TRAIL_WIDE", "0.20"))      # 20%
        self.TIME_STOP_SEC = int(os.getenv("SELL_TIME_STOP_SEC", "900"))   # 15 min
        self.TIME_STOP_MIN_PNL = float(os.getenv("SELL_TIME_STOP_MIN_PNL", "0.05"))

    def run_once(self):
        now = time.time()
        positions = self.db.get_open_positions()
        if not positions:
            return

        for pos in positions:
            mint = pos["mint"]
            entry = pos["entry_price"]
            size = pos["size"]
            entry_ts = pos["entry_ts"]

            price = self.price_feed.get_price(mint)
            if not price or price <= 0:
                continue

            pnl = (price - entry) / entry

            highest = pos.get("highest_price") or entry
            highest = max(highest, price)
            self.db.update_position(mint, highest_price=highest)

            # === HARD STOP ===
            if pnl <= -self.HARD_SL:
                self.trader.sell_all(mint, size, "hard_sl")
                continue

            # === TIME STOP ===
            if now - entry_ts > self.TIME_STOP_SEC and pnl < self.TIME_STOP_MIN_PNL:
                self.trader.sell_all(mint, size, "time_stop")
                continue

            # === TP1 ===
            if not pos["tp1_done"] and pnl >= self.TP1_PCT:
                qty = size * self.TP1_SIZE
                self.trader.sell_partial(mint, qty, "tp1")
                self.db.mark_tp1(mint)
                continue

            # === TP2 ===
            if pos["tp1_done"] and not pos["tp2_done"] and pnl >= self.TP2_PCT:
                qty = size * self.TP2_SIZE
                self.trader.sell_partial(mint, qty, "tp2")
                self.db.mark_tp2(mint)
                continue

            # === TRAILING ===
            trail = self.TRAIL_WIDE if pos["tp2_done"] else self.TRAIL_TIGHT
            stop_price = highest * (1 - trail)

            if price <= stop_price:
                self.trader.sell_all(mint, size, "trailing_stop")
                continue
