from __future__ import annotations

import json
import time
from typing import Dict, Any, List

from config import settings


POSITIONS_FILE = "positions.json"


class TradingEngine:
    def __init__(self, wallet, logger, positions_file: str, mode: str):
        self.wallet = wallet
        self.logger = logger
        self.mode = (mode or "PAPER").upper()
        self.positions_file = positions_file or POSITIONS_FILE

        self.positions: Dict[str, Dict[str, Any]] = {}
        self.buy_inflight = set()
        self.last_buy_ts = 0.0

        from core.real_executor import RealExecutor
        from core.paper_executor import PaperExecutor
        self.executor = RealExecutor(wallet, logger) if self.mode == "REAL" else PaperExecutor(wallet, logger)

        self._load_positions()
        self.logger.info("[TradingEngine] Ready mode=%s", self.mode)

    # ---------------- persistence ----------------
    def _load_positions(self):
        try:
            with open(self.positions_file, "r") as f:
                self.positions = json.load(f)
        except Exception:
            self.positions = {}

    def _save_positions(self):
        with open(self.positions_file, "w") as f:
            json.dump(self.positions, f, indent=2)

    # ---------------- strategy ----------------
    def _should_sell(self, pos: Dict[str, Any], price: float):
        entry = pos["entry_price"]
        high = pos["highest_price"]

        sl_price = entry * 0.90          # -10%
        trail_price = high * 0.90        # -10% from high

        if price <= sl_price:
            return "STOP_LOSS"

        if high > entry and price <= trail_price:
            return "TRAILING"

        return None

    # ---------------- main loop ----------------
    async def on_overviews(self, overviews: List[Dict[str, Any]], risk_checker):
        now = time.time()

        # -------- SELL CHECK FIRST --------
        for ov in overviews:
            mint = ov.get("mint")
            price = ov.get("price_usd")
            if not mint or not price:
                continue

            pos = self.positions.get(mint)
            if not pos or pos["status"] != "OPEN":
                continue

            price = float(price)
            pos["last_price"] = price
            pos["highest_price"] = max(pos["highest_price"], price)

            reason = self._should_sell(pos, price)
            if reason:
                self.logger.info("[SELL] %s reason=%s price=%.8f", mint, reason, price)
                try:
                    res = await self.executor.sell(mint)
                    pos["status"] = "CLOSED"
                    pos["sell_price"] = price
                    pos["sell_ts"] = now
                    pos["sell_reason"] = reason
                    pos["sell_tx"] = res.get("signature")
                    self._save_positions()
                    self.logger.info("[SELL OK] %s tx=%s", mint, pos["sell_tx"])
                except Exception as e:
                    self.logger.error("[SELL ERROR] %s %s", mint, e, exc_info=True)

        # -------- BUY --------
        for ov in overviews:
            mint = ov.get("mint")
            price = ov.get("price_usd")
            dex = (ov.get("dex_id") or "").lower()

            if not mint or not price:
                continue

            if self.mode == "REAL" and dex != "raydium":
                continue

            if mint in self.positions and self.positions[mint]["status"] == "OPEN":
                continue  # ðŸš« no double-buy

            if mint in self.buy_inflight:
                continue

            if now - self.last_buy_ts < getattr(settings, "BUY_COOLDOWN_SECONDS", 0):
                continue

            ok, reason = risk_checker.allow_buy(ov)
            if not ok:
                continue

            sol_amount = float(getattr(settings, "BUY_AMOUNT_SOL", 0))
            if sol_amount <= 0:
                continue

            self.buy_inflight.add(mint)
            try:
                res = await self.executor.buy(mint, sol_amount, float(price))
                self.positions[mint] = {
                    "status": "OPEN",
                    "entry_price": float(price),
                    "highest_price": float(price),
                    "buy_ts": now,
                    "buy_tx": res.get("signature"),
                }
                self._save_positions()
                self.last_buy_ts = now
                self.logger.info("[BUY OK] %s tx=%s", mint, res.get("signature"))
                break
            except Exception as e:
                self.logger.error("[BUY ERROR] %s %s", mint, e, exc_info=True)
            finally:
                self.buy_inflight.discard(mint)
